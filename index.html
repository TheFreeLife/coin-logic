<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinLogic - 스마트 코인 어시스턴트</title>
    <!-- Tailwind CSS & DaisyUI CDN -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Lightweight Charts CDN -->
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        html, body {
            max-width: 100%;
            overflow-x: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
        }
        .font-mono {
            font-family: 'JetBrains+Mono', monospace;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }
        /* Fullscreen Chart Style */
        .chart-fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            background: #0f172a !important;
            margin: 0 !important;
            border: none !important;
            border-radius: 0 !important;
        }
    </style>
</head>
<body class="text-slate-200 min-h-screen overflow-x-hidden">

    <div class="max-w-[1600px] mx-auto p-4 lg:p-6 overflow-hidden">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6 w-full overflow-hidden">
            <div class="flex items-center gap-3">
                <div class="bg-primary p-2 rounded-xl">
                    <i data-lucide="trending-up" class="text-primary-content w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">CoinLogic</h1>
                    <div class="flex items-center gap-2">
                        <p class="text-[10px] text-slate-400 uppercase tracking-widest">Statistical Assistant</p>
                        <div id="wsStatus" class="badge badge-error badge-xs" title="Disconnected"></div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <a href="stats.html" class="btn btn-sm btn-outline btn-primary hover:text-white transition-all">
                    <i data-lucide="line-chart" class="w-4 h-4 mr-2"></i>
                    전략 검증 산출
                </a>
                <button id="refreshBtn" class="btn btn-sm btn-ghost hover:bg-slate-800">
                    <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                    데이터 갱신
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Sidebar: Market List -->
            <div class="lg:col-span-3 space-y-4 order-2 lg:order-1">
                <div class="card bg-slate-800 border border-slate-700 shadow-xl h-[850px] flex flex-col">
                    <div class="p-4 border-b border-slate-700 space-y-3">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold flex items-center gap-2 text-sm">
                                <i data-lucide="list" class="w-4 h-4 text-primary"></i>
                                업비트 KRW 마켓
                            </h3>
                        </div>
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-2 w-4 h-4 text-slate-500"></i>
                            <input type="text" id="marketSearch" placeholder="코인명/심볼 검색" class="input input-xs w-full pl-9 h-8 bg-slate-900 border-slate-700 focus:border-primary">
                        </div>
                        <div class="flex justify-between px-2 text-[10px] text-slate-500 font-bold uppercase select-none">
                            <span class="cursor-pointer hover:text-slate-300 transition-colors" onclick="setSort('name')">
                                코인명 <span id="sort_name"></span>
                            </span>
                            <div class="flex gap-6">
                                <span class="cursor-pointer hover:text-slate-300 transition-colors" onclick="setSort('changeRate')">
                                    현재가/변동 <span id="sort_changeRate"></span>
                                </span>
                                <span class="w-12 text-right cursor-pointer hover:text-slate-300 transition-colors" onclick="setSort('tradePrice')">
                                    거래대금 <span id="sort_tradePrice"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto custom-scrollbar" id="marketList">
                        <div class="p-8 text-center text-slate-500 text-sm">목록 로딩 중...</div>
                    </div>
                </div>
            </div>

            <!-- Center Content -->
            <div class="lg:col-span-9 space-y-6 order-1 lg:order-2">
                <!-- Top Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="card bg-slate-800 border border-slate-700 shadow-xl overflow-hidden relative h-32">
                        <div id="priceFlash" class="absolute inset-0 bg-emerald-500/10 opacity-0 transition-opacity duration-150"></div>
                        <div class="card-body p-4 md:p-5 relative z-10 justify-center">
                            <div class="flex justify-between items-start mb-1 md:mb-2">
                                <span class="text-slate-400 text-[9px] md:text-[11px] font-bold uppercase tracking-widest">현재가 (실시간)</span>
                                <div id="priceChangeBadge" class="badge badge-success badge-xs md:badge-sm gap-1 font-bold">0%</div>
                            </div>
                            <div id="currentPrice" class="text-2xl md:text-4xl font-extrabold font-mono tracking-tight tabular-nums truncate">0</div>
                            <div class="flex justify-between items-center mt-1 md:mt-2">
                                <div class="text-[9px] md:text-[10px] text-slate-500 font-mono" id="tradeTime">-</div>
                                <div class="badge badge-outline badge-xs opacity-50 text-[8px] md:text-[9px]">UPBIT</div>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-slate-800 border border-slate-700 shadow-xl h-32">
                        <div class="card-body p-4 md:p-5 flex-row justify-between items-center tabular-nums">
                            <div class="space-y-1 flex-1 min-w-0">
                                <span class="text-slate-400 text-[9px] md:text-[10px] font-bold uppercase">24시간 고가</span>
                                <div id="highPrice" class="font-mono text-emerald-400 text-xs md:text-sm truncate">0</div>
                                <div id="highRate" class="text-[9px] text-emerald-500/80 font-bold">+0%</div>
                            </div>
                            <div class="divider divider-horizontal mx-1 md:mx-2"></div>
                            <div class="space-y-1 text-right flex-1 min-w-0">
                                <span class="text-slate-400 text-[9px] md:text-[10px] font-bold uppercase">24시간 저가</span>
                                <div id="lowPrice" class="font-mono text-rose-400 text-xs md:text-sm truncate">0</div>
                                <div id="lowRate" class="text-[9px] text-rose-500/80 font-bold">-0%</div>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-slate-800 border border-slate-700 shadow-xl h-32">
                        <div class="card-body p-4 md:p-5 flex-row justify-between items-center tabular-nums">
                            <div class="space-y-1 flex-1 min-w-0">
                                <span class="text-slate-400 text-[9px] md:text-[10px] font-bold uppercase">거래대금 (당일)</span>
                                <div id="tradePrice" class="font-mono text-xs md:text-sm truncate">0</div>
                            </div>
                            <div class="divider divider-horizontal mx-1 md:mx-2"></div>
                            <div class="space-y-1 text-right flex-1 min-w-0">
                                <span class="text-slate-400 text-[9px] md:text-[10px] font-bold uppercase">거래량 (당일)</span>
                                <div id="volume" class="font-mono text-xs md:text-sm uppercase truncate">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="card bg-slate-800 border border-slate-700 shadow-xl h-[600px] md:h-[850px] overflow-hidden min-w-0">
                    <div class="card-body p-2 md:p-4 flex flex-col min-w-0 h-full overflow-hidden">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 md:mb-6 px-2 gap-2 flex-none min-w-0">
                            <div class="flex items-center gap-2 flex-wrap min-w-0 flex-none">
                                <div id="favoriteTimeframes" class="flex gap-1 flex-wrap"></div>
                                <button onclick="timeframe_modal.showModal()" class="btn btn-xs btn-ghost border border-slate-700 hover:bg-slate-700 h-7 px-2">
                                    <i data-lucide="settings-2" class="w-3 h-3 text-slate-400 mr-1"></i>
                                    봉 설정
                                </button>
                                <button onclick="indicator_modal.showModal(); syncIndicatorUI();" class="btn btn-xs btn-ghost border border-slate-700 hover:bg-slate-700 h-7 px-2">
                                    <i data-lucide="layers" class="w-3 h-3 text-slate-400 mr-1"></i>
                                    지표 설정
                                </button>
                            </div>
                            
                            <div class="flex items-center gap-4 ml-auto">
                                <div class="text-[10px] text-slate-400" id="lastUpdated">-</div>
                                <button onclick="toggleFullscreen()" class="btn btn-xs btn-ghost btn-square border border-slate-700">
                                    <i id="fullscreenIcon" data-lucide="maximize" class="w-3 h-3 text-slate-400"></i>
                                </button>
                            </div>
                        </div>
                        <div id="mainChart" class="flex-1 w-full min-h-0 min-w-0 relative"></div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Timeframe Selection Modal -->
    <dialog id="timeframe_modal" class="modal">
        <div class="modal-box bg-slate-800 border border-slate-700 max-w-sm">
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                <i data-lucide="clock" class="w-5 h-5 text-primary"></i>
                시간봉 설정
            </h3>
            <div id="allTimeframesList" class="grid grid-cols-2 gap-2"></div>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn btn-sm btn-primary">닫기</button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <!-- Indicator Selection Modal -->
    <dialog id="indicator_modal" class="modal">
        <div class="modal-box bg-slate-800 border border-slate-700 max-w-sm p-0 overflow-hidden">
            <div class="p-6 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <i data-lucide="layers" class="w-5 h-5 text-primary"></i>
                    보조지표 설정
                </h3>
                <form method="dialog"><button class="btn btn-sm btn-ghost btn-circle">✕</button></form>
            </div>
            
            <div class="p-4 space-y-1">
                <!-- Volume -->
                <div class="flex items-center justify-between p-2 hover:bg-slate-700/30 rounded-lg transition-colors">
                    <label class="flex items-center gap-3 cursor-pointer flex-1">
                        <input type="checkbox" class="checkbox checkbox-sm checkbox-primary" id="check_volume" onchange="toggleIndicator('volume', this.checked)">
                        <span class="font-bold text-sm">거래량 (Volume)</span>
                    </label>
                </div>

                <div class="divider my-1 opacity-50"></div>

                <!-- Moving Averages (Unified) -->
                <div class="space-y-2 p-2 hover:bg-slate-700/30 rounded-lg transition-colors group">
                    <div class="flex items-center justify-between">
                        <label class="flex items-center gap-3 cursor-pointer flex-1">
                            <input type="checkbox" class="checkbox checkbox-sm checkbox-primary" id="check_ma_all" onchange="toggleIndicator('ma_active', this.checked)">
                            <span class="text-sm font-bold">이동평균선 (MA)</span>
                        </label>
                        <button onclick="toggleConfig('ma_list')" class="btn btn-ghost btn-xs btn-square text-slate-500 hover:text-primary">
                            <i data-lucide="settings-2" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                    <div id="config_ma_list" class="hidden pl-8 pr-2 pb-2 space-y-2">
                        <div id="ma_inputs_container" class="grid grid-cols-2 gap-2">
                            <!-- 10개의 MA 입력 필드가 자바스크립트로 생성됨 -->
                        </div>
                        <p class="text-[9px] text-slate-500 mt-2">* 기간을 0으로 설정하면 표시되지 않습니다.</p>
                    </div>
                </div>

                <div class="divider my-1 opacity-50"></div>

                <!-- RSI -->
                <div class="space-y-2 p-2 hover:bg-slate-700/30 rounded-lg transition-colors group">
                    <div class="flex items-center justify-between">
                        <label class="flex items-center gap-3 cursor-pointer flex-1">
                            <input type="checkbox" class="checkbox checkbox-sm checkbox-primary" id="check_rsi" onchange="toggleIndicator('rsi', this.checked)">
                            <span class="text-sm font-bold">RSI</span>
                        </label>
                        <button onclick="toggleConfig('rsi')" class="btn btn-ghost btn-xs btn-square text-slate-500 hover:text-primary">
                            <i data-lucide="settings-2" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                    <div id="config_rsi" class="hidden pl-8 pr-2 pb-2">
                        <div class="flex items-center justify-between bg-slate-900/50 p-2 rounded-md border border-slate-700">
                            <span class="text-[11px] text-slate-400">RSI 산출 기간</span>
                            <input type="number" id="input_rsi_p" class="input input-xs bg-slate-800 border-slate-600 w-16 text-right font-mono" onchange="updateIndicatorParam('rsi_p', this.value)">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-slate-800/50 border-t border-slate-700 flex justify-end">
                <form method="dialog"><button class="btn btn-sm btn-primary px-6">완료</button></form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <script>
        let state = {
            currentMarket: 'KRW-BTC',
            timeframe: localStorage.getItem('selectedTimeframe') || 'minutes/1',
            markets: [],
            chart: null,
            series: null,
            socket: null,
            lastPrice: 0,
            candleData: [],
            isLoadingHistory: false, // 과거 데이터 로딩 중 여부
            isHistoryEnded: false, // 더 이상 과거 데이터가 없는지 여부
            hoveredCandle: null,
            favorites: JSON.parse(localStorage.getItem('timeframeFavorites')) || ['minutes/1', 'minutes/15', 'minutes/60', 'days'],
            searchTerm: '',
            sortKey: 'tradePrice', // 정렬 기준: tradePrice, name, changeRate
            sortOrder: 'desc', // 정렬 순서: asc, desc
            allTimeframes: [
                { id: 'minutes/1', label: '1분' }, { id: 'minutes/3', label: '3분' },
                { id: 'minutes/5', label: '5분' }, { id: 'minutes/10', label: '10분' },
                { id: 'minutes/15', label: '15분' }, { id: 'minutes/30', label: '30분' },
                { id: 'minutes/60', label: '1시간' }, { id: 'minutes/240', label: '4시간' },
                { id: 'days', label: '일봉' }, { id: 'weeks', label: '주봉' }, { id: 'months', label: '월봉' }
            ],
            indicatorSettings: (() => {
                const defaults = {
                    volume: true, ma_active: true,
                    maList: [5, 10, 20, 60, 120, 0, 0, 0, 0, 0],
                    rsi: false, rsi_p: 14
                };
                const saved = JSON.parse(localStorage.getItem('indicatorSettings'));
                return saved ? { ...defaults, ...saved } : defaults;
            })(),
            indicatorSeries: {},
            maColors: ['#f59e0b', '#3b82f6', '#a855f7', '#10b981', '#ef4444', '#06b6d4', '#f43f5e', '#84cc16', '#eab308', '#6366f1']
        };

        const fmt = new Intl.NumberFormat('ko-KR');

        // 지표 계산 함수들
        function calculateMA(data, period) {
            const p = parseInt(period);
            if (p <= 0) return [];
            return data.map((_, i) => {
                if (i < p - 1) return null;
                const sum = data.slice(i - p + 1, i + 1).reduce((acc, c) => acc + c.close, 0);
                return { time: data[i].time, value: sum / p };
            }).filter(v => v !== null);
        }

        function calculateRSI(data, period = 14) {
            const p = parseInt(period);
            let gains = [], losses = [];
            for (let i = 1; i < data.length; i++) {
                let diff = data[i].close - data[i-1].close;
                gains.push(Math.max(0, diff)); losses.push(Math.max(0, -diff));
            }
            let avgGain = gains.slice(0, p).reduce((a, b) => a + b, 0) / p;
            let avgLoss = losses.slice(0, p).reduce((a, b) => a + b, 0) / p;
            const rsi = [];
            for (let i = p; i < data.length; i++) {
                avgGain = (avgGain * (p - 1) + gains[i-1]) / p;
                avgLoss = (avgLoss * (p - 1) + losses[i-1]) / p;
                rsi.push({ time: data[i].time, value: 100 - (100 / (1 + (avgGain / avgLoss))) });
            }
            return rsi;
        }

        function toggleIndicator(key, checked) {
            state.indicatorSettings[key] = checked;
            localStorage.setItem('indicatorSettings', JSON.stringify(state.indicatorSettings));
            renderIndicators();
        }

        function updateIndicatorParam(key, val) {
            state.indicatorSettings[key] = val;
            localStorage.setItem('indicatorSettings', JSON.stringify(state.indicatorSettings));
            renderIndicators();
        }

        function updateMA(index, val) {
            state.indicatorSettings.maList[index] = parseInt(val) || 0;
            localStorage.setItem('indicatorSettings', JSON.stringify(state.indicatorSettings));
            renderIndicators();
        }

        function toggleConfig(key) {
            const el = document.getElementById(`config_${key}`);
            if (el) {
                const isHidden = el.classList.contains('hidden');
                document.querySelectorAll('[id^="config_"]').forEach(c => c.classList.add('hidden'));
                if (isHidden) el.classList.remove('hidden');
            }
        }

        function renderIndicators() {
            if (!state.chart || !state.series || state.candleData.length === 0) return;

            // 기존 지표 시리즈 제거
            Object.values(state.indicatorSeries).forEach(s => {
                if (s) try { state.chart.removeSeries(s); } catch(e) {}
            });
            state.indicatorSeries = {};

            // 1. 거래량 (Volume)
            if (state.indicatorSettings.volume) {
                const volSeries = state.chart.addHistogramSeries({
                    color: '#26a69a', priceFormat: { type: 'volume' }, priceScaleId: 'volume',
                });
                volSeries.setData(state.candleData.map(c => ({
                    time: c.time, value: c.volume || 0, 
                    color: c.close >= c.open ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'
                })));
                state.chart.priceScale('volume').applyOptions({
                    scaleMargins: { top: 0.8, bottom: 0 },
                });
                state.indicatorSeries.volume = volSeries;
            }

            // 2. 이동평균선들 (MA List)
            if (state.indicatorSettings.ma_active) {
                state.indicatorSettings.maList.forEach((period, idx) => {
                    if (period > 0) {
                        const series = state.chart.addLineSeries({ 
                            color: state.maColors[idx], 
                            lineWidth: 1, 
                            crosshairMarkerVisible: false, 
                            lastValueVisible: false, 
                            priceLineVisible: false,
                            title: `MA${period}`
                        });
                        series.setData(calculateMA(state.candleData, period));
                        state.indicatorSeries[`ma_${idx}`] = series;
                    }
                });
            }

            // 3. RSI
            if (state.indicatorSettings.rsi) {
                const rsiSeries = state.chart.addLineSeries({
                    color: '#ec4899', lineWidth: 1, priceScaleId: 'rsi', title: 'RSI',
                });
                rsiSeries.setData(calculateRSI(state.candleData, state.indicatorSettings.rsi_p));
                state.chart.priceScale('rsi').applyOptions({
                    scaleMargins: { top: 0.1, bottom: 0.7 },
                    borderVisible: true,
                });
                state.indicatorSeries.rsi = rsiSeries;
            }
        }

        // 초기 체크박스 및 입력 필드 동기화
        function syncIndicatorUI() {
            const settings = state.indicatorSettings;
            if (!settings.maList) settings.maList = [5, 10, 20, 60, 120, 0, 0, 0, 0, 0];
            
            // 일반 체크박스
            if (document.getElementById('check_volume')) document.getElementById('check_volume').checked = settings.volume;
            if (document.getElementById('check_ma_all')) document.getElementById('check_ma_all').checked = settings.ma_active;
            if (document.getElementById('check_rsi')) document.getElementById('check_rsi').checked = settings.rsi;
            
            // RSI 기간
            if (document.getElementById('input_rsi_p')) document.getElementById('input_rsi_p').value = settings.rsi_p;

            // MA 입력 필드 동적 생성 및 값 설정
            const maContainer = document.getElementById('ma_inputs_container');
            if (maContainer) {
                maContainer.innerHTML = settings.maList.map((p, i) => `
                    <div class="flex items-center gap-1.5 bg-slate-900/30 p-1 rounded border border-slate-700/50">
                        <div class="w-1 h-4 rounded-full" style="background-color: ${state.maColors[i]}"></div>
                        <input type="number" value="${p}" 
                            class="input input-xs bg-transparent border-none w-full text-right p-0 font-mono text-[10px]" 
                            placeholder="0"
                            onchange="updateMA(${i}, this.value)">
                    </div>
                `).join('');
            }
        }
        const fmtCompact = new Intl.NumberFormat('ko-KR', { notation: 'compact', maximumFractionDigits: 1 });

        const currentPriceEl = document.getElementById('currentPrice');
        const priceChangeBadge = document.getElementById('priceChangeBadge');
        const highPriceEl = document.getElementById('highPrice');
        const lowPriceEl = document.getElementById('lowPrice');
        const highRateEl = document.getElementById('highRate');
        const lowRateEl = document.getElementById('lowRate');
        const volumeEl = document.getElementById('volume');
        const tradePriceEl = document.getElementById('tradePrice');
        const tradeTimeEl = document.getElementById('tradeTime');
        const priceFlashEl = document.getElementById('priceFlash');
        const wsStatusEl = document.getElementById('wsStatus');
        const lastUpdatedEl = document.getElementById('lastUpdated');

        // 툴팁 엘리먼트 생성
        const tooltip = document.createElement('div');
        tooltip.className = 'fixed hidden z-50 p-3 bg-slate-900/95 border border-slate-700 rounded-xl shadow-2xl pointer-events-none text-[11px] font-mono leading-relaxed min-w-[140px] backdrop-blur-sm';
        document.body.appendChild(tooltip);

        async function fetchMarkets() {
            try {
                const response = await fetch('https://api.upbit.com/v1/market/all');
                const data = await response.json();
                state.markets = data.filter(m => m.market.startsWith('KRW-')).map(m => ({
                    id: m.market,
                    name: m.korean_name,
                    symbol: m.market.split('-')[1],
                    exchange: 'UPBIT',
                    price: 0, 
                    change: 'EVEN', 
                    changeRate: 0, 
                    tradePrice: 0
                }));
                renderMarketList();
            } catch (error) { console.error('Markets fetch failed:', error); }
        }

        async function fetchCandles() {
            try {
                state.isHistoryEnded = false; // 마켓/봉 변경 시 초기화
                const url = `https://api.upbit.com/v1/candles/${state.timeframe}?market=${state.currentMarket}&count=200`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                state.candleData = data.map(c => ({
                    time: Math.floor(new Date(c.candle_date_time_kst).getTime() / 1000),
                    open: c.opening_price, high: c.high_price, low: c.low_price, close: c.trade_price,
                    volume: c.candle_acc_trade_volume
                })).sort((a, b) => a.time - b.time);
                updateChart();
                renderIndicators(); // 지표 렌더링 추가
            } catch (error) { console.error('Candles fetch failed:', error); }
        }

        function setSort(key) {
            if (state.sortKey === key) {
                state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortKey = key;
                state.sortOrder = 'desc';
            }
            renderMarketList();
        }

        function renderMarketList() {
            const listEl = document.getElementById('marketList');
            if (!listEl) return;

            // 정렬 화살표 업데이트
            ['name', 'changeRate', 'tradePrice'].forEach(k => {
                const el = document.getElementById(`sort_${k}`);
                if (el) el.innerText = state.sortKey === k ? (state.sortOrder === 'asc' ? '▲' : '▼') : '';
            });

            const filtered = state.markets.filter(m => m.name.includes(state.searchTerm) || m.symbol.toLowerCase().includes(state.searchTerm.toLowerCase()));
            
            // 정렬 적용
            filtered.sort((a, b) => {
                let valA = a[state.sortKey];
                let valB = b[state.sortKey];
                
                if (state.sortOrder === 'asc') return valA > valB ? 1 : -1;
                else return valA < valB ? 1 : -1;
            });

            listEl.innerHTML = filtered.map(m => `
                <div onclick="changeMarket('${m.id}')" class="flex items-center justify-between p-3 border-b border-slate-700/30 cursor-pointer hover:bg-slate-700/50 transition-colors ${m.id === state.currentMarket ? 'bg-slate-700 border-l-4 border-l-primary' : ''}">
                    <div class="flex-1 min-w-0 text-left">
                        <div class="flex items-center gap-1.5">
                            <div class="text-[11px] font-bold truncate">${m.name}</div>
                            <span class="text-[8px] bg-slate-900 text-slate-500 px-1 rounded border border-slate-700 leading-none py-0.5">${m.exchange || 'UPBIT'}</span>
                        </div>
                        <div class="text-[9px] text-slate-500">${m.symbol}</div>
                    </div>
                    <div class="text-right flex-shrink-0 ml-2">
                        <div class="text-[11px] font-mono font-bold ${m.change === 'RISE' ? 'text-emerald-400' : m.change === 'FALL' ? 'text-rose-400' : ''}">
                            ${fmt.format(m.price || 0)}
                        </div>
                        <div class="text-[9px] ${m.change === 'RISE' ? 'text-emerald-500' : m.change === 'FALL' ? 'text-rose-500' : 'text-slate-500'}">
                            ${m.changeRate > 0 ? '+' : ''}${(m.changeRate || 0).toFixed(2)}%
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0 ml-4 w-16">
                        <div class="text-[9px] text-slate-400 font-mono">${fmtCompact.format(m.tradePrice || 0)}</div>
                    </div>
                </div>
            `).join('');
        }

        function changeMarket(id) {
            state.currentMarket = id;
            refreshAll();
        }

        function initWebSocket() {
            if (state.socket) state.socket.close();
            state.socket = new WebSocket('wss://api.upbit.com/websocket/v1');
            state.socket.binaryType = 'blob';
            state.socket.onopen = () => {
                wsStatusEl.className = 'badge badge-success badge-xs';
                state.socket.send(JSON.stringify([{"ticket":"coin-logic"},{"type":"ticker","codes": state.markets.map(m => m.id)}]));
            };
            state.socket.onmessage = async (evt) => {
                const data = JSON.parse(await evt.data.text());
                const idx = state.markets.findIndex(m => m.id === data.code);
                if (idx > -1) {
                    state.markets[idx].price = data.trade_price;
                    state.markets[idx].change = data.change;
                    state.markets[idx].changeRate = data.signed_change_rate * 100;
                    state.markets[idx].tradePrice = data.acc_trade_price;
                    if (data.code === state.currentMarket) handleTickerUpdate(data);
                }
            };
            state.socket.onclose = () => { wsStatusEl.className = 'badge badge-error badge-xs'; setTimeout(initWebSocket, 3000); };
        }

        setInterval(renderMarketList, 1000);

        function handleTickerUpdate(data) {
            const price = data.trade_price;
            if (state.lastPrice !== price) {
                priceFlashEl.style.opacity = '1'; setTimeout(() => priceFlashEl.style.opacity = '0', 100);
            }
            currentPriceEl.innerText = fmt.format(price);
            priceChangeBadge.innerText = `${data.signed_change_rate > 0 ? '+' : ''}${(data.signed_change_rate * 100).toFixed(2)}%`;
            priceChangeBadge.className = `badge badge-sm gap-1 font-medium ${data.change === 'RISE' ? 'badge-success' : 'badge-error'}`;
            highPriceEl.innerText = fmt.format(data.high_price);
            lowPriceEl.innerText = fmt.format(data.low_price);
            const openPrice = data.opening_price;
            highRateEl.innerText = `+${((data.high_price - openPrice) / openPrice * 100).toFixed(2)}%`;
            lowRateEl.innerText = `${((data.low_price - openPrice) / openPrice * 100).toFixed(2)}%`;
            volumeEl.innerText = fmtCompact.format(data.acc_trade_volume);
            tradePriceEl.innerText = fmtCompact.format(data.acc_trade_price) + ' 원';
            tradeTimeEl.innerText = new Date(data.trade_timestamp).toLocaleTimeString();
            
            if (state.series && state.candleData.length > 0) {
                const last = state.candleData[state.candleData.length - 1];
                const updated = { ...last, close: price, high: Math.max(last.high, price), low: Math.min(last.low, price) };
                state.series.update(updated);
                state.candleData[state.candleData.length - 1] = updated;
                
                // 실시간 지표 갱신
                renderIndicators();
            }
            state.lastPrice = price;
        }

        async function fetchHistory(to) {
            if (state.isLoadingHistory || state.isHistoryEnded) return;
            state.isLoadingHistory = true;
            
            try {
                // 너무 잦은 요청 방지 (300ms 딜레이)
                await new Promise(r => setTimeout(r, 300));

                const toDate = new Date(to * 1000).toISOString();
                const url = `https://api.upbit.com/v1/candles/${state.timeframe}?market=${state.currentMarket}&count=200&to=${toDate}`;
                const response = await fetch(url);
                
                if (response.status === 429) {
                    console.warn('Too Many Requests - cooling down');
                    // 429 발생 시 잠시 후 다시 시도할 수 있도록 처리하거나, 
                    // 그냥 이번 요청은 실패로 처리하고 사용자가 다시 스크롤하게 함.
                    // 여기서는 isLoadingHistory만 false로 돌려서 사용자 스크롤 시 재시도하도록 함.
                    return; 
                }
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                
                if (data.length === 0) {
                    state.isHistoryEnded = true;
                    console.log('No more history data');
                    return;
                }

                const history = data.map(c => ({
                    time: Math.floor(new Date(c.candle_date_time_kst).getTime() / 1000),
                    open: c.opening_price, high: c.high_price, low: c.low_price, close: c.trade_price,
                    volume: c.candle_acc_trade_volume
                })).sort((a, b) => a.time - b.time);

                // 기존 데이터 앞에 붙이기 (중복 제거)
                const firstTime = state.candleData[0].time;
                const newHistory = history.filter(h => h.time < firstTime);
                
                if (newHistory.length === 0) {
                    state.isHistoryEnded = true;
                    return;
                }

                state.candleData = [...newHistory, ...state.candleData];
                state.series.setData(state.candleData);
                renderIndicators(); // 지표 갱신 추가
            } catch (error) {
                console.error('History fetch failed:', error);
            } finally {
                state.isLoadingHistory = false;
            }
        }

        function updateChart() {
            const container = document.querySelector("#mainChart");
            if (!container || !window.LightweightCharts) return;
            
            // 모바일에서는 차트 높이를 더 작게 설정
            const isMobile = window.innerWidth < 768;
            const chartHeight = isMobile ? 450 : 730;

            if (!state.chart) {
                state.chart = LightweightCharts.createChart(container, {
                    width: container.offsetWidth, 
                    height: chartHeight,
                    layout: { background: { type: LightweightCharts.ColorType.Solid, color: 'transparent' }, textColor: '#94a3b8' },
                    grid: { vertLines: { color: '#1e293b' }, horzLines: { color: '#1e293b' } },
                    rightPriceScale: { borderColor: '#1e293b', autoScale: true },
                    timeScale: { 
                        borderColor: '#1e293b', 
                        timeVisible: true,
                        secondsVisible: false,
                        tickMarkFormatter: (time, tickMarkType, locale) => {
                            const date = new Date(time * 1000);
                            switch(tickMarkType) {
                                case 0: // Year
                                    return `${date.getFullYear()}년`;
                                case 1: // Month
                                    return `${date.getMonth() + 1}월`;
                                case 2: // Day
                                    return `${date.getDate()}일`;
                                case 3: // Time
                                    return `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                                default:
                                    return `${date.getMonth() + 1}/${date.getDate()}`;
                            }
                        }
                    },
                    localization: {
                        locale: 'ko-KR',
                        priceFormatter: val => fmt.format(val),
                        dateFormat: 'yyyy-MM-dd',
                        timeFormatter: (time) => {
                            const date = new Date(time * 1000);
                            return `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
                        }
                    },
                    handleScroll: true,
                    handleScale: true,
                });
                state.series = state.chart.addCandlestickSeries({ upColor: '#10b981', downColor: '#ef4444', borderVisible: false, wickUpColor: '#10b981', wickDownColor: '#ef4444' });
                
                // 스크롤 감지 (무한 스크롤)
                state.chart.timeScale().subscribeVisibleLogicalRangeChange(range => {
                    if (range && range.from < 10 && state.candleData.length > 0) {
                        fetchHistory(state.candleData[0].time);
                    }
                });

                state.chart.subscribeCrosshairMove(param => {
                    if (param && param.time && param.point) {
                        const d = param.seriesData.get(state.series);
                        if (d) {
                            tooltip.style.display = 'block';
                            const diff = d.close - d.open;
                            const diffRate = (diff / d.open * 100).toFixed(2);
                            const color = diff >= 0 ? 'text-emerald-400' : 'text-rose-400';
                            
                            const hDiff = ((d.high - d.open) / d.open * 100).toFixed(2);
                            const lDiff = ((d.low - d.open) / d.open * 100).toFixed(2);
                            
                            tooltip.innerHTML = `
                                <div class="flex flex-col gap-1">
                                    <div class="text-slate-500 mb-1 border-b border-slate-800 pb-1 text-[10px]">${new Date(param.time * 1000).toLocaleString()}</div>
                                    <div class="flex justify-between gap-6"><span>O</span><span class="text-slate-200">${fmt.format(d.open)}</span></div>
                                    <div class="flex justify-between gap-6">
                                        <span>H</span>
                                        <div class="flex gap-1.5 items-baseline">
                                            <span class="text-emerald-400 font-medium">${fmt.format(d.high)}</span>
                                            <span class="text-emerald-400 text-[10px] font-medium">(+${hDiff}%)</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between gap-6">
                                        <span>L</span>
                                        <div class="flex gap-1.5 items-baseline">
                                            <span class="text-rose-400 font-medium">${fmt.format(d.low)}</span>
                                            <span class="text-rose-400 text-[10px] font-medium">(${lDiff}%)</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between gap-6"><span>C</span><span class="text-slate-200">${fmt.format(d.close)}</span></div>
                                    <div class="flex justify-between gap-6 mt-1 border-t border-slate-800 pt-1 font-medium ${color}">
                                        <span>${diff >= 0 ? '▲' : '▼'}</span>
                                        <span>${fmt.format(Math.abs(diff))} (${diffRate}%)</span>
                                    </div>
                                </div>
                            `;

                            // 툴팁 위치 계산 (fixed 속성이므로 뷰포트 기준 좌표 사용)
                            const rect = container.getBoundingClientRect();
                            const tooltipWidth = 180;
                            const tooltipHeight = 160;
                            
                            // 뷰포트 내 절대 좌표
                            let x = param.point.x + rect.left + 15;
                            let y = param.point.y + rect.top - tooltipHeight - 15;

                            // 화면 우측 경계 체크 (뷰포트 너비 기준)
                            if (x + tooltipWidth > window.innerWidth) {
                                x = param.point.x + rect.left - tooltipWidth - 15;
                            }
                            // 화면 상단 경계 체크 (뷰포트 상단 기준)
                            if (y < 10) {
                                y = param.point.y + rect.top + 15;
                            }

                            tooltip.style.left = x + 'px';
                            tooltip.style.top = y + 'px';
                        } else {
                            tooltip.style.display = 'none';
                        }
                    } else {
                        tooltip.style.display = 'none';
                    }
                });

                // ResizeObserver를 사용하여 박스 크기에 완벽하게 차트 크기를 맞춤
                const resizeObserver = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        const { width, height } = entry.contentRect;
                        if (state.chart && width > 0 && height > 0) {
                            state.chart.applyOptions({ width, height });
                            // 초기 렌더링 시 데이터가 보이지 않는 현상 방지
                            setTimeout(() => state.chart.timeScale().fitContent(), 0);
                        }
                    }
                });
                resizeObserver.observe(container);
            }
            state.series.setData(state.candleData);
            state.chart.timeScale().fitContent();
        }

        function renderTimeframeUI() {
            document.getElementById('favoriteTimeframes').innerHTML = state.allTimeframes.filter(tf => state.favorites.includes(tf.id)).map(tf => `
                <button onclick="setTimeframe('${tf.id}')" class="btn btn-xs border-slate-700 ${state.timeframe === tf.id ? 'btn-primary' : 'btn-outline'}">${tf.label}</button>
            `).join('');
            document.getElementById('allTimeframesList').innerHTML = state.allTimeframes.map(tf => `
                <div class="flex items-center justify-between p-2 rounded hover:bg-slate-700 group cursor-pointer" onclick="setTimeframe('${tf.id}')">
                    <span class="text-sm ${state.timeframe === tf.id ? 'text-primary font-bold' : ''}">${tf.label}</span>
                    <button onclick="event.stopPropagation(); toggleFavorite('${tf.id}')" class="btn btn-xs btn-ghost btn-square"><i data-lucide="star" class="w-4 h-4 ${state.favorites.includes(tf.id) ? 'fill-yellow-400 text-yellow-400' : 'text-slate-500'}"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function setTimeframe(id) { state.timeframe = id; localStorage.setItem('selectedTimeframe', id); renderTimeframeUI(); fetchCandles(); }
        
        function toggleFullscreen() {
            const chartCard = document.querySelector('#mainChart').closest('.card');
            const icon = document.getElementById('fullscreenIcon');
            const isFull = chartCard.classList.toggle('chart-fullscreen');
            
            if (isFull) {
                icon.setAttribute('data-lucide', 'minimize');
            } else {
                icon.setAttribute('data-lucide', 'maximize');
            }
            lucide.createIcons();

            // 차트 크기 재계산
            setTimeout(() => {
                const container = document.querySelector("#mainChart");
                if (state.chart && container) {
                    state.chart.applyOptions({ 
                        width: container.clientWidth,
                        height: isFull ? window.innerHeight - 60 : 730 
                    });
                }
            }, 100);
        }

        // ESC 키로 전체화면 해제
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const chartCard = document.querySelector('.chart-fullscreen');
                if (chartCard) toggleFullscreen();
            }
        });

        function toggleFavorite(id) {
            const idx = state.favorites.indexOf(id);
            if (idx > -1) { if (state.favorites.length > 1) state.favorites.splice(idx, 1); }
            else { if (state.favorites.length >= 7) { alert("최대 7개 가능"); return; } state.favorites.push(id); }
            localStorage.setItem('timeframeFavorites', JSON.stringify(state.favorites)); renderTimeframeUI();
        }

        document.getElementById('marketSearch').addEventListener('input', (e) => { state.searchTerm = e.target.value; renderMarketList(); });
        document.getElementById('refreshBtn').addEventListener('click', () => refreshAll());

        async function refreshAll() { await fetchCandles(); initWebSocket(); }
        async function init() { renderTimeframeUI(); await fetchMarkets(); await refreshAll(); lucide.createIcons(); }
        init();
    </script>
</body>
</html>