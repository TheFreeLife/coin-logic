<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinLogic - 전략 검증 시뮬레이터</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Lightweight Charts CDN -->
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
        .font-mono { font-family: 'JetBrains+Mono', monospace; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-200 min-h-screen">
    <div class="max-w-[1400px] mx-auto p-4 lg:p-6">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-3">
                <a href="index.html" class="bg-primary p-2 rounded-xl inline-block">
                    <i data-lucide="trending-up" class="text-primary-content w-6 h-6"></i>
                </a>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">Strategy Tester</h1>
                    <p class="text-[10px] text-slate-400 uppercase tracking-widest">Statistical Backtesting</p>
                </div>
            </div>
            <a href="index.html" class="btn btn-sm btn-ghost gap-2">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                차트로 돌아가기
            </a>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Sidebar: Configuration -->
            <div class="lg:col-span-4 space-y-6">
                <div class="card bg-slate-800 border border-slate-700 shadow-xl">
                    <div class="card-body p-6 space-y-4">
                        <h3 class="text-lg font-bold flex items-center gap-2 mb-2">
                            <i data-lucide="settings" class="w-5 h-5 text-primary"></i>
                            조건 설정
                        </h3>

                        <!-- Market Selection -->
                        <div class="form-control w-full">
                            <label class="label"><span class="label-text text-slate-400 font-bold text-xs uppercase">대상 코인</span></label>
                            <select id="marketSelect" class="select select-bordered bg-slate-900 border-slate-700 w-full focus:border-primary">
                                <option disabled selected>코인을 선택하세요</option>
                            </select>
                        </div>

                        <!-- Timeframe Selection -->
                        <div class="form-control w-full">
                            <label class="label"><span class="label-text text-slate-400 font-bold text-xs uppercase">봉 주기</span></label>
                            <select id="timeframeSelect" class="select select-bordered bg-slate-900 border-slate-700 w-full focus:border-primary">
                                <option value="minutes/1">1분봉</option>
                                <option value="minutes/3">3분봉</option>
                                <option value="minutes/5">5분봉</option>
                                <option value="minutes/10">10분봉</option>
                                <option value="minutes/15">15분봉</option>
                                <option value="minutes/30">30분봉</option>
                                <option value="minutes/60" selected>1시간봉</option>
                                <option value="minutes/240">4시간봉</option>
                                <option value="days">일봉</option>
                                <option value="weeks">주봉</option>
                                <option value="months">월봉</option>
                            </select>
                        </div>

                        <div class="divider"></div>

                        <!-- Strategy Type -->
                        <div class="form-control w-full">
                            <label class="label"><span class="label-text text-slate-400 font-bold text-xs uppercase">매수 전략</span></label>
                            <select id="strategyType" class="select select-bordered bg-slate-900 border-slate-700 w-full focus:border-primary">
                                <option value="rsi_oversold">RSI 과매도 (30 이하)</option>
                                <option value="rsi_rebound">RSI 30 상향 돌파</option>
                                <option value="ma_golden_cross">이평선 골든크로스 (5/20)</option>
                                <option value="price_rebound">전봉 대비 5% 하락 후 반등</option>
                            </select>
                        </div>

                        <div class="divider"></div>

                        <!-- Exit Conditions -->
                        <div class="space-y-4">
                            <h4 class="text-xs font-bold text-slate-500 uppercase">익절 / 손절 조건</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-control">
                                    <label class="label"><span class="label-text text-xs">목표 수익 (%)</span></label>
                                    <input type="number" id="takeProfit" value="5" class="input input-bordered bg-slate-900 border-slate-700 w-full focus:border-primary">
                                </div>
                                <div class="form-control">
                                    <label class="label"><span class="label-text text-xs">손절 제한 (%)</span></label>
                                    <input type="number" id="stopLoss" value="3" class="input input-bordered bg-slate-900 border-slate-700 w-full focus:border-primary">
                                </div>
                            </div>
                        </div>

                        <button id="runSimBtn" class="btn btn-primary w-full mt-4 gap-2">
                            <i data-lucide="play-circle" class="w-5 h-5"></i>
                            시뮬레이션 실행 (10k 캔들)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Panel: Results -->
            <div class="lg:col-span-8 space-y-6">
                <!-- Analysis Chart -->
                <div class="card bg-slate-800 border border-slate-700 shadow-xl overflow-hidden min-w-0">
                    <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                        <h3 class="font-bold flex items-center gap-2 text-sm">
                            <i data-lucide="line-chart" class="w-4 h-4 text-primary"></i>
                            전략 시각화 분석
                        </h3>
                        <div class="text-[10px] text-slate-500 font-mono" id="chartInfo">캔들 로드 대기 중</div>
                    </div>
                    <div id="statsChart" class="w-full h-[400px]"></div>
                </div>

                <!-- Summary Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="statsSummary">
                    <div class="card bg-slate-800 border border-slate-700 p-4">
                        <span class="text-slate-500 text-[10px] font-bold uppercase mb-1">총 매매 횟수</span>
                        <div id="totalTrades" class="text-2xl font-bold font-mono">-</div>
                    </div>
                    <div class="card bg-slate-800 border border-slate-700 p-4">
                        <span class="text-slate-500 text-[10px] font-bold uppercase mb-1">승률</span>
                        <div id="winRate" class="text-2xl font-bold font-mono text-emerald-400">-</div>
                    </div>
                    <div class="card bg-slate-800 border border-slate-700 p-4">
                        <span class="text-slate-500 text-[10px] font-bold uppercase mb-1">누적 수익률</span>
                        <div id="totalReturn" class="text-2xl font-bold font-mono">-</div>
                    </div>
                    <div class="card bg-slate-800 border border-slate-700 p-4">
                        <span class="text-slate-500 text-[10px] font-bold uppercase mb-1">평균 수익률/회</span>
                        <div id="avgDuration" class="text-2xl font-bold font-mono">-</div>
                    </div>
                </div>

                <!-- Simulation Progress/Log -->
                <div class="card bg-slate-800 border border-slate-700 shadow-xl flex-1 overflow-hidden">
                    <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                        <h3 class="font-bold flex items-center gap-2 text-sm">
                            <i data-lucide="list" class="w-4 h-4 text-primary"></i>
                            매매 기록 (최근순)
                        </h3>
                        <div id="simStatus" class="text-[10px] uppercase font-bold text-slate-500">대기 중</div>
                    </div>
                    <div class="overflow-x-auto h-[550px] custom-scrollbar">
                        <table class="table table-pin-rows bg-slate-800">
                            <thead>
                                <tr class="bg-slate-900/50 text-slate-400 border-b border-slate-700">
                                    <th>날짜/시간</th>
                                    <th>매수가</th>
                                    <th>매도가</th>
                                    <th>수익률</th>
                                    <th>결과</th>
                                </tr>
                            </thead>
                            <tbody id="tradeLog">
                                <tr>
                                    <td colspan="5" class="text-center py-20 text-slate-500">조건 설정 후 시뮬레이션을 실행하세요.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const state = {
            markets: [],
            candles: [],
            isSimulating: false,
            chart: null,
            series: null,
            isLoadingHistory: false,
            isHistoryEnded: false
        };

        const fmt = new Intl.NumberFormat('ko-KR');

        function initChart() {
            const container = document.getElementById('statsChart');
            if (state.chart) { container.innerHTML = ''; state.chart = null; }
            state.chart = LightweightCharts.createChart(container, {
                layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#94a3b8' },
                grid: { vertLines: { color: '#1e293b' }, horzLines: { color: '#1e293b' } },
                rightPriceScale: { borderColor: '#1e293b', autoScale: true },
                timeScale: { borderColor: '#1e293b', timeVisible: true },
            });
            state.series = state.chart.addCandlestickSeries({ upColor: '#10b981', downColor: '#ef4444', borderVisible: false, wickUpColor: '#10b981', wickDownColor: '#ef4444' });
            state.chart.timeScale().subscribeVisibleLogicalRangeChange(range => { if (range && range.from < 10) fetchHistory(); });
            new ResizeObserver(entries => { for (let entry of entries) if (state.chart) state.chart.applyOptions({ width: entry.contentRect.width }); }).observe(container);
        }

        async function fetchHistory() {
            if (state.isLoadingHistory || state.isHistoryEnded || state.candles.length === 0) return;
            state.isLoadingHistory = true;
            const market = document.getElementById('marketSelect').value;
            const timeframe = document.getElementById('timeframeSelect').value;
            const firstTime = state.candles[0].time;
            const toDate = new Date(firstTime * 1000).toISOString();
            try {
                const response = await fetch(`https://api.upbit.com/v1/candles/${timeframe}?market=${market}&count=200&to=${toDate}`);
                const data = await response.json();
                if (data.length === 0) { state.isHistoryEnded = true; return; }
                const history = data.map(c => ({
                    time: Math.floor(new Date(c.candle_date_time_kst).getTime() / 1000),
                    open: c.opening_price, high: c.high_price, low: c.low_price, close: c.trade_price,
                    raw_time: c.candle_date_time_kst
                })).sort((a, b) => a.time - b.time);
                const newHistory = history.filter(h => h.time < firstTime);
                if (newHistory.length === 0) { state.isHistoryEnded = true; return; }
                state.candles = [...newHistory, ...state.candles];
                state.series.setData(state.candles);
            } catch (e) { console.error(e); } finally { state.isLoadingHistory = false; }
        }

        async function updatePreviewChart() {
            const market = document.getElementById('marketSelect').value;
            const timeframe = document.getElementById('timeframeSelect').value;
            if (!market || !timeframe) return;
            try {
                const response = await fetch(`https://api.upbit.com/v1/candles/${timeframe}?market=${market}&count=200`);
                const rawData = await response.json();
                state.candles = rawData.map(c => ({
                    time: Math.floor(new Date(c.candle_date_time_kst).getTime() / 1000),
                    open: c.opening_price, high: c.high_price, low: c.low_price, close: c.trade_price,
                    raw_time: c.candle_date_time_kst
                })).sort((a, b) => a.time - b.time);
                state.series.setData(state.candles);
                state.chart.timeScale().fitContent();
                state.series.setMarkers([]);
                state.isHistoryEnded = false;
                document.getElementById('chartInfo').innerText = `최근 캔들 ${state.candles.length}개 로드됨`;
            } catch (e) { console.error(e); }
        }

        async function fetchLargeData(market, timeframe, targetCount = 10000) {
            let allCandles = [];
            let lastTime = null;
            const chunks = Math.ceil(targetCount / 200);
            for (let i = 0; i < chunks; i++) {
                const toParam = lastTime ? `&to=${lastTime}` : '';
                const response = await fetch(`https://api.upbit.com/v1/candles/${timeframe}?market=${market}&count=200${toParam}`);
                const data = await response.json();
                if (!data || data.length === 0) break;
                const chunk = data.map(c => ({
                    time: Math.floor(new Date(c.candle_date_time_kst).getTime() / 1000),
                    open: c.opening_price, high: c.high_price, low: c.low_price, close: c.trade_price,
                    raw_time: c.candle_date_time_kst
                }));
                allCandles = [...chunk.reverse(), ...allCandles];
                lastTime = data[data.length - 1].candle_date_time_kst;
                document.getElementById('simStatus').innerText = `수집 중 (${Math.round(((i + 1) / chunks) * 100)}%)`;
                await new Promise(r => setTimeout(r, 100));
            }
            return allCandles.sort((a, b) => a.time - b.time);
        }

        function calculateRSI(data, period = 14) {
            let gains = [], losses = [];
            for (let i = 1; i < data.length; i++) {
                let diff = data[i].close - data[i-1].close;
                gains.push(Math.max(0, diff)); losses.push(Math.max(0, -diff));
            }
            let avgGain = gains.slice(0, period).reduce((a, b) => a + b) / period;
            let avgLoss = losses.slice(0, period).reduce((a, b) => a + b) / period;
            let rsi = new Array(period).fill(null);
            for (let i = period; i < data.length; i++) {
                avgGain = (avgGain * (period - 1) + gains[i-1]) / period;
                avgLoss = (avgLoss * (period - 1) + losses[i-1]) / period;
                rsi.push(100 - (100 / (1 + (avgGain / avgLoss))));
            }
            return rsi;
        }

        function calculateMA(data, period) {
            let ma = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) { ma.push(null); continue; }
                let sum = 0; for (let j = 0; j < period; j++) sum += data[i-j].close;
                ma.push(sum / period);
            }
            return ma;
        }

        document.getElementById('runSimBtn').addEventListener('click', async () => {
            if (state.isSimulating) return;
            const market = document.getElementById('marketSelect').value;
            const timeframe = document.getElementById('timeframeSelect').value;
            const strategy = document.getElementById('strategyType').value;
            const tp = parseFloat(document.getElementById('takeProfit').value) / 100;
            const sl = parseFloat(document.getElementById('stopLoss').value) / 100;

            state.isSimulating = true;
            document.getElementById('runSimBtn').innerText = "데이터 수집 중...";
            try {
                const candles = await fetchLargeData(market, timeframe, 10000);
                state.candles = candles;
                document.getElementById('simStatus').innerText = "조건 분석 중...";
                const rsi = calculateRSI(candles), ma5 = calculateMA(candles, 5), ma20 = calculateMA(candles, 20);
                let trades = [], activeTrade = null;

                for (let i = 1; i < candles.length; i++) {
                    const current = candles[i];
                    if (!activeTrade) {
                        let buy = false;
                        if (strategy === 'rsi_oversold' && rsi[i] !== null && rsi[i] <= 30) buy = true;
                        else if (strategy === 'rsi_rebound' && rsi[i-1] < 30 && rsi[i] >= 30) buy = true;
                        else if (strategy === 'ma_golden_cross' && ma5[i-1] <= ma20[i-1] && ma5[i] > ma20[i]) buy = true;
                        else if (strategy === 'price_rebound' && i > 1 && candles[i-1].close < candles[i-2].close * 0.95 && current.close > candles[i-1].close) buy = true;
                        if (buy) activeTrade = { entryPrice: current.close, entryTime: current.raw_time };
                    } else {
                        const profit = (current.close - activeTrade.entryPrice) / activeTrade.entryPrice;
                        if (profit >= tp || profit <= -sl) {
                            trades.push({ ...activeTrade, exitPrice: current.close, exitTime: current.raw_time, profitRate: profit * 100 });
                            activeTrade = null;
                        }
                    }
                }
                state.series.setData(state.candles);
                document.getElementById('chartInfo').innerText = `캔들 ${state.candles.length}개 분석 완료`;
                const markers = [];
                trades.forEach(t => {
                    markers.push({ time: Math.floor(new Date(t.entryTime).getTime() / 1000), position: 'belowBar', color: '#10b981', shape: 'arrowUp', text: 'BUY' });
                    markers.push({ time: Math.floor(new Date(t.exitTime).getTime() / 1000), position: 'aboveBar', color: '#ef4444', shape: 'arrowDown', text: 'SELL' });
                });
                state.series.setMarkers(markers.sort((a, b) => a.time - b.time));
                state.chart.timeScale().fitContent();
                renderResults(trades);
            } catch (e) { console.error(e); } finally {
                state.isSimulating = false;
                document.getElementById('runSimBtn').innerHTML = '<i data-lucide="play-circle" class="w-5 h-5"></i>시뮬레이션 실행 (10k 캔들)';
                document.getElementById('simStatus').innerText = "완료";
                lucide.createIcons();
            }
        });

        function renderResults(trades) {
            const logEl = document.getElementById('tradeLog');
            if (trades.length === 0) {
                logEl.innerHTML = '<tr><td colspan="5" class="text-center py-20 text-slate-500">체결된 거래가 없습니다.</td></tr>';
                ['totalTrades', 'winRate', 'totalReturn', 'avgDuration'].forEach(id => document.getElementById(id).innerText = "-");
                return;
            }
            const winCount = trades.filter(t => t.profitRate > 0).length;
            const winRate = (winCount / trades.length * 100).toFixed(1);
            const totalReturn = trades.reduce((acc, t) => acc + t.profitRate, 0).toFixed(2);
            document.getElementById('totalTrades').innerText = trades.length;
            document.getElementById('winRate').innerText = winRate + "%";
            document.getElementById('winRate').className = `text-2xl font-bold font-mono ${winRate >= 50 ? 'text-emerald-400' : 'text-rose-400'}`;
            document.getElementById('totalReturn').innerText = totalReturn + "%";
            document.getElementById('totalReturn').className = `text-2xl font-bold font-mono ${totalReturn >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;
            document.getElementById('avgDuration').innerText = (totalReturn / trades.length).toFixed(2) + "%";
            logEl.innerHTML = trades.reverse().map(t => `
                <tr class="hover:bg-slate-700/30 border-b border-slate-700/50 transition-colors text-xs">
                    <td class="text-[10px] text-slate-400 font-mono">${t.entryTime.replace('T', ' ')}</td>
                    <td class="font-mono">${fmt.format(t.entryPrice)}</td>
                    <td class="font-mono">${fmt.format(t.exitPrice)}</td>
                    <td class="font-mono font-bold ${t.profitRate >= 0 ? 'text-emerald-400' : 'text-rose-400'}">${t.profitRate > 0 ? '+' : ''}${t.profitRate.toFixed(2)}%</td>
                    <td><span class="badge ${t.profitRate >= 0 ? 'badge-success' : 'badge-error'} badge-xs font-bold">${t.profitRate >= 0 ? '수익' : '손실'}</span></td>
                </tr>
            `).join('');
        }

        async function init() {
            lucide.createIcons(); initChart();
            try {
                const response = await fetch('https://api.upbit.com/v1/market/all');
                const data = await response.json();
                state.markets = data.filter(m => m.market.startsWith('KRW-'));
                const select = document.getElementById('marketSelect');
                state.markets.forEach(m => {
                    const opt = document.createElement('option'); opt.value = m.market; opt.innerText = `${m.korean_name} (${m.market.split('-')[1]})`;
                    if (m.market === 'KRW-BTC') opt.selected = true;
                    select.appendChild(opt);
                });
                updatePreviewChart();
            } catch (e) { console.error(e); }
            document.getElementById('marketSelect').addEventListener('change', updatePreviewChart);
            document.getElementById('timeframeSelect').addEventListener('change', updatePreviewChart);
        }
        init();
    </script>
</body>
</html>